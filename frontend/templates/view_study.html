{% extends "base.html" %}

{% block head %}
  {{ super() }}
  <script type="text/javascript">
    let studyId = "{{ study.id }}";
  </script>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.1/css/jquery.dataTables.css">
  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.1/js/jquery.dataTables.js"></script>
  <script src="/static/javascript/participants_table.js" type="text/javascript"></script>
{% endblock %}

{% block title %}View Study{% endblock %}

{% block content %}
  <div class="container" style="max-width:1920px;">
    
    {% if site_admin or is_study_admin %}
      <div class="col-xs-8 row"> 
        <div class="row"> 
          <h1>{{ study.name }}</h1>
        </div>
      </div>

      <div class="col-xs-2 text-align-right"> 
        <a href="/edit_study/{{ study['id'] }}" class="btn btn-info h3-margins">
          Edit This Study
        </a>
      </div>

      <div class="col-xs-2 pull-right"> 
        <a href="/dashboard/{{ study['id'] }}" class="btn btn-info h3-margins">
          View the Study Dashboard
        </a>
      </div>

    {% else %}
      <div class="col-xs-10 row"> 
        <div class="row"> 
          <h1>{{ study.name }}</h1>
        </div>
      </div>   

      <div class="col-xs-2 text-align-right right-neg-4"> 
        <a href="/dashboard/{{ study['id'] }}" class="btn btn-info h3-margins">
          View the Study Dashboard
        </a>
      </div>
    {% endif %}


    <div class="col-xs-12 row"> 
      <i> 
      <div class="col-xs-9 row pull-left"> 
        {% if not study.is_test %}
          Note: data in this study is restricted, only Forest summaries are accessible to Researchers 
        {% endif %}
      </div>
      <div class="col-xs-3 pull-right text-align-right right-neg-4"> 
        <p>ID: {{ study.object_id }}</p>
      </div>
      </i>
    </div>

    <div class="row">
      <div class="col-lg-12 row">
        <h3>Participants</h3>
      </div>
    </div>

    <div class="row">
      <div class="col-xs-12 well">        
        <p>Total participants ever registered on this study: 
          {{ "{:,}".format(participants_ever_registered_count) }}</p>

        <table class="table row" id="participantList">
          <thead>
          <tr>
            <th>Creation Date</th>
            <th>Patient ID</th>
            <th>Phone registered</th>
            <th>Phone OS</th>
            {% if push_notifications_enabled %}
              {% for intervention in interventions | sort(case_sensitive=False) %}
                <th>{{ intervention }}</th>
              {% endfor %}
            {% endif %}
            {% for field in study_fields | sort(case_sensitive=False) %}
              <th>{{ field }}</th>
            {% endfor %}
          </tr>
          </thead>
        </table>
        <form action="/create_new_participant" method="post">
          <div class="form-inline pull-left">
            <input type="hidden" name="study_id" value="{{ study.id }}">
            <button type="submit" class="btn btn-primary add_new_patient_button">Add new participant</button>
          </div>
        </form>

        <button type="button" class="btn btn-warning add_many_patients_button" data-toggle="modal" data-target="#addManyPatientsModal" 
        title="Enable a number of new participants to enroll in {{ study.name }}: 
        download a file of new Patient IDs and registration passwords">Add many new participants</button>
        {% include 'create_many_participants_modal.html' %}
      </div>
    </div>

    <div class="col-xs-11 row"> 
      <h3 class="row"> Surveys </h3>
    </div>
    <div class="col-xs-1"> 
      <a href="/create_survey/{{ study.id }}/tracking_survey" class="btn btn-info h3-margins pull-right">
        Create New <b>Survey</b></a>
    </div>
    
    <div class="row">
      <div class="list-group well col-xs-12">
        {% if tracking_survey_info %}
          {% for info in tracking_survey_info %}
          
            <div class="col-xs-12">
              <a href="/edit_survey/{{study_id}}/{{info["id"] }}" class="list-group-item survey-button-margins row">  
                {% if info["name"] != "" %}
                  <span class="col-xs-9 row"> {{info["name"]}} </span>
                {% else %}
                  <span class="col-xs-9 row" style="color:gray;"> (Unnamed Survey) </span>
                {% endif %}
                
                {# stick these metadata into a small table so we can stack them #}
                <table class="pull-right survey-inline-table survey-micro-label">
                  <tr> <td>
                    <span> Survey ID #{{info["object_id"]}} </span>
                  </td> </tr>
                  <tr> <td>
                    <span> Updated: {{info["last_updated"]}} </span>
                  </td></tr>
                </table>
                </a>
            </div>
          {% endfor %}
        {% else %}
          This study does not have any Surveys.
        {% endif %}
      </div>
    </div>

    <div class="col-xs-11 row"> 
      <h3 class="row"> Audio Surveys </h3>
    </div>
    <div class="col-xs-1"> 
      <a href="/create_survey/{{ study.id }}/audio_survey" class="btn btn-info h3-margins pull-right">
        Create New <b>Audio Survey</b></a>
    </div>

    <div class="row">
      <div class="list-group well col-xs-12">
        {% if audio_survey_info %}
          {% for info in audio_survey_info %}
          
            <div class="col-xs-12">
              <a href="/edit_survey/{{study_id}}/{{info["id"] }}" class="list-group-item survey-button-margins row">  
                {% if info["name"] != "" %}
                  <span class="col-xs-9 row"> {{info["name"]}} </span>
                {% else %}
                  <span class="col-xs-9 row" style="color:gray;"> (Unnamed Survey) </span>
                {% endif %}
                
                {# stick these metadata into a small table so we can stack them #}
                <table class="pull-right survey-inline-table survey-micro-label">
                  <tr> <td>
                    <span> Survey ID #{{info["object_id"]}} </span>
                  </td> </tr>
                  <tr> <td>
                    <span> Updated: {{info["last_updated"]}} </span>
                  </td></tr>
                </table>
                </a>
            </div>
          {% endfor %}
        {% else %}
          This study does not have any Audio Surveys.
        {% endif %}
      </div>
    </div>

    <div class="col-xs-11 row"> 
      <h3 class="row"> Image Surveys </h3>
    </div>
    <div class="col-xs-1"> 
      <a href="/create_survey/{{ study.id }}/image_survey" class="btn btn-info h3-margins pull-right">
        Create New <b>Image Survey</b></a>
    </div>

    <div class="row">
      <div class="list-group well col-xs-12">
        {% if image_survey_info %}
          {% for info in image_survey_info %}
          
            <div class="col-xs-12">
              <a href="/edit_survey/{{study_id}}/{{info["id"] }}" class="list-group-item survey-button-margins row">  
                {% if info["name"] != "" %}
                  <span class="col-xs-9 row"> {{info["name"]}} </span>
                {% else %}
                  <span class="col-xs-9 row" style="color:gray;"> (Unnamed Survey) </span>
                {% endif %}
                
                {# stick these metadata into a small table so we can stack them #}
                <table class="pull-right survey-inline-table survey-micro-label">
                  <tr> <td>
                    <span> Survey ID #{{info["object_id"]}} </span>
                  </td> </tr>
                  <tr> <td>
                    <span> Updated: {{info["last_updated"]}} </span>
                  </td></tr>
                </table>
                </a>
            </div>
          {% endfor %}
        {% else %}
          This study does not have any Image Surveys.
        {% endif %}
      </div>
    </div>

    <div class="row" >
      <h3>Study Configuration</h3>
      
      <div class="col-xs-12 well ">  
        {% if push_notifications_enabled %}
          <div class="col-xs-3">

            <p><a class="btn btn-info h3-margins" 
            href={{ easy_url("study_api.interventions_page", study_id=study.id) }}>
              Edit Interventions
            </a></p>
            Configure Interventions for use with Relative survey schedules
          </div>
          
        {% endif %}

        <div class="col-xs-6">
          <p><a class="btn btn-info h3-margins"  href="/device_settings/{{ study['id'] }}">
            Edit App Settings
          </a></p>
          Configure types and quantity of the passive data streams this study collects, and the wording that study participants see in the app
        </div>

        <div class="col-xs-3">
          <p><a class="btn btn-info h3-margins"  href="/study_fields/{{ study['id'] }}">
            Edit Custom Fields
          </a></p>
          Edit custom tags for organizing participants in your study.
        </div>
      </div>
    </div>

    {% if study.forest_enabled %}
      <div class="row" >
        <h3>Forest Data Analysis</h3>
        <div class="col-xs-12 well">

          {% if site_admin %}
            <div class="col-xs-4">
              <p><a class="btn btn-info" href="{{ easy_url('forest_pages.create_tasks', study_id=study.id) }}">
                Dispatch New Forest Tasks
              </a></p>
              Queue up new Forest analysis runs on participant data.
            </div>
          {% endif %}

          <div class="col-xs-4">
            <p><a class="btn btn-info" href="{{ easy_url('forest_pages.task_log', study_id=study.id) }}">
              View Forest Task History
            </a></p>
            View the runtime history of all Forest analysis tasks that have run on data from this study.
          </div>
          
          <div class="col-xs-4">
            <p><a class="btn btn-info" href="{{ easy_url('forest_pages.analysis_progress', study_id=study.id) }}">
              View Forest Task Summaries
            </a></p>
            View a high-level summary about the data that Forest analysis run on.
          </div>

        </div>
      </div>
    {% endif %}

  </div>
</div>

{% endblock %}
